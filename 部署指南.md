# GitHub-飞书机器人部署指南

## 概述

本项目是一个基于 Serverless 云函数的 GitHub-飞书机器人，用于将 GitHub 仓库的事件（如代码推送、Issue、Pull Request 等）自动推送到飞书群聊。

## 功能特性

- ✅ 支持 Push 事件推送
- ✅ 支持 Issues 事件推送
- ✅ 支持 Pull Request 事件推送
- ✅ 支持 Release 事件推送
- ✅ 飞书卡片消息格式
- ✅ GitHub Webhook 签名验证
- ✅ 飞书机器人签名验证

## 部署步骤

### 第一步：创建飞书自定义机器人

1. 在飞书群聊中，点击右上角设置图标
2. 选择"群机器人" → "添加机器人" → "自定义机器人"
3. 配置机器人名称和描述
4. **重要**：开启"签名校验"，记录下生成的 Secret（后续需要用到）
5. 复制生成的 Webhook URL

### 第二步：准备 GitHub 仓库

1. 将本项目代码上传到你的 GitHub 仓库
2. 确保包含以下文件：
   - `api/index.py`
   - `requirements.txt`
   - `vercel.json`

### 第三步：部署到 Vercel

1. 访问 [vercel.com](https://vercel.com) 并用 GitHub 账号登录
2. 点击 "Add New..." → "Project"
3. 选择你的 GitHub 仓库并点击 "Import"
4. Vercel 会自动识别为 Python 项目，无需修改设置
5. 点击 "Deploy" 开始部署

### 第四步：配置环境变量

在 Vercel 项目设置页面，找到 "Environment Variables" 并添加：

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `GITHUB_SECRET` | GitHub Webhook 签名密钥 | `your_github_secret` |
| `FEISHU_WEBHOOK_URL` | 飞书机器人 Webhook URL | `https://open.feishu.cn/open-apis/bot/v2/hook/xxx` |
| `FEISHU_SECRET` | 飞书机器人签名密钥 | `your_feishu_secret` |

### 第五步：配置 GitHub Webhook

1. 进入你要监控的 GitHub 仓库
2. 点击 "Settings" → "Webhooks" → "Add webhook"
3. 配置以下信息：
   - **Payload URL**: 你的 Vercel 部署 URL（如 `https://your-project.vercel.app/`）
   - **Content type**: `application/json`
   - **Secret**: 设置一个密钥（与环境变量 `GITHUB_SECRET` 保持一致）
   - **Which events**: 选择你需要的事件类型
     - ✅ Pushes
     - ✅ Issues  
     - ✅ Pull requests
     - ✅ Releases
4. 点击 "Add webhook" 保存

## 测试验证

1. 向仓库推送一些代码
2. 创建或修改 Issue
3. 创建 Pull Request
4. 检查飞书群聊是否收到相应的卡片消息

## 故障排除

### 没有收到消息

1. 检查 Vercel 项目的 "Functions" 页面查看日志
2. 检查 GitHub Webhook 的 "Recent Deliveries" 查看请求状态
3. 确认环境变量配置正确
4. 确认飞书机器人 URL 有效

### 签名验证失败

1. 确认 `GITHUB_SECRET` 与 GitHub Webhook 设置的 Secret 一致
2. 确认 `FEISHU_SECRET` 与飞书机器人的签名校验密钥一致

### 消息格式异常

1. 检查飞书卡片消息格式是否正确
2. 参考 [飞书消息卡片文档](https://open.feishu.cn/document/ukTMukTMukTM/uEjNwUjLxYDM14SM2ATN) 调整格式

## 本地开发

1. 复制 `env.example` 为 `.env` 并填入配置
2. 安装依赖：`pip install -r requirements.txt`
3. 运行服务：`python api/index.py`
4. 使用 ngrok 等工具暴露本地端口用于测试

## 扩展功能

项目采用模块化设计，可以轻松添加更多事件处理器：

1. 在 `api/index.py` 中添加新的事件处理函数
2. 在 `webhook_handler` 中添加对应的事件类型判断
3. 重新部署即可生效

## 支持的事件类型

- `push` - 代码推送
- `issues` - Issue 相关操作
- `pull_request` - Pull Request 相关操作  
- `release` - 版本发布

更多事件类型可参考 [GitHub Webhook 文档](https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads)。
